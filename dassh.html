<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Blue Basin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.5.2/dist/maplibre-gl.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js/dist/Chart.min.css" />
    <style>
      body.dashboard-dark {
        display: flex;
        min-height: 100vh;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #181f2c;
        color: #e0e6ed;
      }
      .sidebar {
        width: 90px;
        background: linear-gradient(180deg, #0f1d3d 0%, #2e5885 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 24px 0 0 0;
        box-shadow: 2px 0 10px rgba(0,0,0,0.08);
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 1100;
      }
      .sidebar-header {
        margin-bottom: 20px;
      }
      .sidebar-logo {
        width: 48px;
        border-radius: 50%;
        background: #fff;
        padding: 4px;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 32px;
        width: 100%;
      }
      .sidebar-link {
        color: #e0e6ed;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 0 12px 0;
        justify-content: center;
        border-left: 4px solid transparent;
        font-size: 1.15rem;
        transition: background 0.2s, border-color 0.2s, color 0.2s;
      }
      .sidebar-link.active, .sidebar-link:hover {
        background: #24304a;
        border-left: 4px solid #81baa2;
        color: #81baa2;
      }
      .sidebar-user {
        margin-top: auto;
        margin-bottom: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      .sidebar-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #81baa2;
        object-fit: cover;
      }
      .sidebar-username {
        font-weight: 600;
        font-size: 1rem;
        color: #fff;
      }
      .sidebar-role {
        font-size: 0.85rem;
        color: #81baa2;
      }
      .dashboard-main {
        margin-left: 90px;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background: #1e2537;
        padding: 0 0 0 0;
      }
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 32px 40px 0 40px;
        background: none;
        gap: 24px;
      }
      .dashboard-title {
        color: #fff;
        font-size: 2.1rem;
        font-weight: 700;
        margin-bottom: 2px;
      }
      .dashboard-date {
        color: #81baa2;
        font-size: 1.1rem;
        font-weight: 500;
      }
      .dashboard-weather-status {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #24304a;
        border-radius: 16px;
        padding: 12px 20px;
        color: #fff;
        font-size: 1.2rem;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.09);
      }
      .dashboard-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-right: 24px;
      }
      .dashboard-widgets-row {
        display: flex;
        gap: 24px;
        margin: 24px 40px 0 40px;
      }
      .dashboard-row {
        display: flex;
        gap: 24px;
        margin: 24px 40px 0 40px;
      }
      .widget {
        background: #232b3e;
        border-radius: 20px;
        padding: 24px;
        flex: 1;
        min-width: 0;
        box-shadow: 0 2px 12px rgba(0,0,0,0.11);
        color: #e0e6ed;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .widget-title {
        font-size: 1.05rem;
        color: #81baa2;
        font-weight: 700;
        margin-bottom: 12px;
      }
      .widget-highlight {
        min-width: 180px;
        max-width: 220px;
        align-items: center;
        text-align: center;
      }
      .widget-forecast {
        max-width: 260px;
      }
      .widget-map {
        min-width: 0;
        max-width: 100%;
        width: 100%;
        height: 500px;
        position: relative;
        background: #232b3e;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.11);
        color: #e0e6ed;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: stretch;
      }
      .widget-history {
        min-width: 220px;
        max-width: 300px;
      }
      .widget-calendar {
        width: 100%;
      }
      .table-dark {
        background: #232b3e;
        color: #e0e6ed;
      }
      .table-dark thead {
        background: #0f1d3d;
        color: #fff;
      }
      .table-dark tbody tr:hover {
        background: #2e5885;
      }
      /* Icons (placeholder, use SVG or icon font in real app) */
      .icon-weather::before { content: '‚òÄÔ∏è'; }
      .icon-history::before { content: 'üïí'; }
      .icon-map::before { content: 'üó∫Ô∏è'; }
      .icon-tips::before { content: 'üí°'; }
      .icon-exit::before { content: '‚èèÔ∏è'; }
      .sun-cloud::before { content: '‚õÖ'; font-size: 2rem; }
      /* Responsive */
      @media (max-width: 1200px) {
        .dashboard-widgets-row, .dashboard-row {
          flex-direction: column;
        }
        .widget {
          max-width: 100%;
        }
        #sisri-demo-map, #sisri-demo-map3d {
          min-height: 0;
          min-width: 0;
          width: 100%;
          height: 100%;
          max-width: 100%;
          max-height: 100%;
          border-radius: 12px;
          background: #222;
          z-index: 1;
          display: block;
          position: absolute;
          top: 0;
          left: 0;
        }
      }
      @media (max-width: 800px) {
        .sidebar {
          width: 60px;
        }
        .dashboard-main {
          margin-left: 60px;
        }
        .dashboard-header, .dashboard-widgets-row, .dashboard-row {
          margin-left: 8px;
          margin-right: 8px;
          padding-left: 0;
          padding-right: 0;
        }
      }
      #sisri-demo-map, #sisri-demo-map3d {
        width: 100%;
        height: 500px;
        max-width: 100%;
        border-radius: 12px;
        background: #222;
        z-index: 1;
        display: block;
        position: static;
      }
    </style>
</head>
<body class="dashboard-dark">
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="images/logo sisri blanco (1).png" alt="Logo Sisri" class="sidebar-logo">
    </div>
    <nav class="sidebar-nav">
      <a href="dassh.html" class="sidebar-link active"><span class="icon-dashboard"></span> Dashboard</a>
      <a href="#historialRiego" class="sidebar-link"><span class="icon-history"></span> Historial</a>
      <a href="#mapa" class="sidebar-link"><span class="icon-map"></span> Mapas</a>
      <a href="#recomendaciones" class="sidebar-link"><span class="icon-tips"></span> Recomendaciones</a>
      <a href="tablero.html" class="sidebar-link"><span class="icon-tablero"></span> Tablero</a>
      <a href="index.html" class="sidebar-link"><span class="icon-exit"></span> Salir</a>
    </nav>
    <div class="sidebar-user">
      <img src="images/user_avatar.png" alt="Usuario" class="sidebar-avatar">
      <span class="sidebar-username">¬°Hola, Cesar!</span>
      <span class="sidebar-role">Productor Premium</span>
    </div>
  </aside>
  <main class="dashboard-main">
    <header class="dashboard-header">
      <div>
        <h2 class="dashboard-title">Panel de Control SISRI</h2>
        <span class="dashboard-date">Mi√©rcoles, 23 Abril 2025</span>
      </div>
      <div class="dashboard-actions">
        <button id="toggle3d" class="btn btn-outline-primary">Vista 3D/2D</button>
        <button id="togglePred" class="btn btn-warning ms-2">An√°lisis Predictivo</button>
        <button id="toggleHist" class="btn btn-info ms-2">Historial de Riego</button>
      </div>
      <div class="dashboard-weather-status">
        <span class="weather-icon sun-cloud"></span>
        <span class="weather-temp">23¬∞C</span>
        <span class="weather-desc">Nublado parcial</span>
      </div>
    </header>
    <section class="dashboard-widgets-row">
      <div class="widget widget-highlight">
        <div class="widget-title">Humedad Relativa</div>
        <canvas id="chartHumidity" height="80"></canvas>
      </div>
      <div class="widget widget-highlight">
        <div class="widget-title">Radiaci√≥n Solar</div>
        <canvas id="chartRadiation" height="80"></canvas>
      </div>
      <div class="widget widget-highlight">
        <div class="widget-title">Temperatura</div>
        <canvas id="chartTemperature" height="80"></canvas>
      </div>
      <div class="widget widget-highlight">
        <div class="widget-title">Viento</div>
        <canvas id="chartWind" height="80"></canvas>
      </div>
    </section>
    <section class="dashboard-row">
      <div class="widget widget-forecast">
        <div class="widget-title">Pron√≥stico 7 d√≠as</div>
        <div id="forecastList"></div>
      </div>
      <div class="widget widget-map" id="mapa">
        <div class="widget-title">Mapa de Condiciones</div>
        <div id="sisri-demo-map" style="display:block; width:100%; height:100%; border-radius:12px; overflow:hidden; background:#222; z-index:1; position:absolute; top:0; left:0;"></div>
        <div id="sisri-demo-map3d" style="display:none; width:100%; height:100%; border-radius:12px; overflow:hidden; background:#222; z-index:1; position:absolute; top:0; left:0;"></div>
      </div>
    </section>
    <section class="dashboard-row">
      <div class="widget widget-history" id="historialRiego">
        <div class="widget-title">Historial de Riego</div>
        <canvas id="histChart1" height="120"></canvas>
      </div>
      <div class="widget widget-history">
        <div class="widget-title">Humedad del Suelo (3 Semanas)</div>
        <canvas id="histChart2" height="120"></canvas>
      </div>
      <div class="widget widget-history">
        <div class="widget-title">Temperatura Media (3 Semanas)</div>
        <canvas id="histChart3" height="120"></canvas>
      </div>
    </section>
    <section class="dashboard-row" id="recomendaciones">
      <div class="widget widget-calendar">
        <div class="widget-title">Calendario de Riego</div>
        <div class="table-responsive">
          <table class="table table-dark table-striped" id="riegoCalendar">
            <thead><tr><th>D√≠a</th><th>Hora</th><th>Duraci√≥n</th><th>Temp</th><th>Humedad</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- STATE FOR POLYGON AND ZONE ---
    let selectedZoneCoords = null;
    let selectedZoneCenter = null;
    let polygon2dLayer = null;
    let polygon3dLayer = null;

    // --- Chart.js widgets (simulados) ---
    const chartHumidity = new Chart(document.getElementById('chartHumidity').getContext('2d'), {
      type: 'line',
      data: {
        labels: ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],
        datasets: [{
          label: 'Humedad Relativa',
          data: [],
          borderColor: '#2196f3',
          fill: true,
          backgroundColor: 'rgba(33,150,243,0.1)',
          tension: 0.4
        }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    const chartRadiation = new Chart(document.getElementById('chartRadiation').getContext('2d'), {
      type: 'line',
      data: {
        labels: ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],
        datasets: [{
          label: 'Radiaci√≥n Solar',
          data: [],
          borderColor: '#43a047',
          fill: true,
          backgroundColor: 'rgba(67,160,71,0.1)',
          tension: 0.4
        }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    const chartTemperature = new Chart(document.getElementById('chartTemperature').getContext('2d'), {
      type: 'line',
      data: {
        labels: ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],
        datasets: [{
          label: 'Temperatura',
          data: [],
          borderColor: '#ff9800',
          fill: true,
          backgroundColor: 'rgba(255,152,0,0.1)',
          tension: 0.4
        }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    const chartWind = new Chart(document.getElementById('chartWind').getContext('2d'), {
      type: 'line',
      data: {
        labels: ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],
        datasets: [{
          label: 'Viento',
          data: [],
          borderColor: '#00bcd4',
          fill: true,
          backgroundColor: 'rgba(0,188,212,0.1)',
          tension: 0.4
        }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // --- HIDE ALL WIDGETS UNTIL ZONE IS SELECTED ---
    function hideZoneWidgets() {
      document.getElementById('forecastList').innerHTML = '';
      chartHumidity.data.datasets[0].data = [];
      chartRadiation.data.datasets[0].data = [];
      chartTemperature.data.datasets[0].data = [];
      chartWind.data.datasets[0].data = [];
      chartHumidity.update(); chartRadiation.update(); chartTemperature.update(); chartWind.update();
      document.getElementById('histChart1').style.opacity = 0.2;
      document.getElementById('histChart2').style.opacity = 0.2;
      document.getElementById('histChart3').style.opacity = 0.2;
      document.querySelector('#riegoCalendar tbody').innerHTML = '';
    }
    hideZoneWidgets();

    // --- SHOW DATA FOR SELECTED ZONE ---
    function showZoneWidgets(coords) {
      // Simulate data based on zone
      const dias = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
      const icons = ['‚òÄÔ∏è','üå§Ô∏è','üå¶Ô∏è','üåßÔ∏è','‚õÖ','üå§Ô∏è','‚òÄÔ∏è'];
      document.getElementById('forecastList').innerHTML = dias.map((d,i) => `<div style='display:flex;align-items:center;gap:8px;margin-bottom:4px;'><span>${icons[i]}</span><span>${d}</span><span>${20+Math.round(Math.random()*7)}¬∞C</span></div>`).join('');
      chartHumidity.data.datasets[0].data = [60, 62, 61, 59, 60, 62, 63].map(x => x + Math.round(Math.random()*3));
      chartRadiation.data.datasets[0].data = [800, 820, 780, 790, 810, 830, 800].map(x => x + Math.round(Math.random()*20));
      chartTemperature.data.datasets[0].data = [22, 21, 23, 25, 24, 23, 22].map(x => x + Math.round(Math.random()*2));
      chartWind.data.datasets[0].data = [5, 7, 6, 8, 5, 6, 7].map(x => x + Math.round(Math.random()*2));
      chartHumidity.update(); chartRadiation.update(); chartTemperature.update(); chartWind.update();
      document.getElementById('histChart1').style.opacity = 1;
      document.getElementById('histChart2').style.opacity = 1;
      document.getElementById('histChart3').style.opacity = 1;
      // Calendario
      const tbody = document.querySelector('#riegoCalendar tbody');
      tbody.innerHTML = '';
      for (let i=0; i<7; i++) {
        const dia = dias[i];
        const hora = `${8 + Math.floor(Math.random()*6)}:00`;
        const duracion = 20 + Math.floor(Math.random()*25);
        const temp = (20 + Math.random()*8).toFixed(1);
        const hum = (50 + Math.random()*20).toFixed(0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${dia}</td><td>${hora}</td><td>${duracion}</td><td>${temp}</td><td>${hum}</td>`;
        tbody.appendChild(tr);
      }
    }

    // MAPA 2D (Leaflet) con todas sus capacidades: selecci√≥n de zona, edici√≥n y borrado
    var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
    var demoMap = L.map('sisri-demo-map', {
      center: [19.4326, -99.1332],
      zoom: 14,
      layers: [satelliteLayer]
    });
    // Grupo para pol√≠gonos dibujados
    var demoDrawnItems = new L.FeatureGroup();
    demoMap.addLayer(demoDrawnItems);
    // Control de dibujo completo
    var demoDrawControl = new L.Control.Draw({
      edit: {
        featureGroup: demoDrawnItems,
        edit: true,
        remove: true
      },
      draw: {
        polygon: true,
        marker: true,
        polyline: false,
        circle: false,
        rectangle: true,
        circlemarker: false
      }
    });
    demoMap.addControl(demoDrawControl);
    // Al crear zona
    demoMap.on(L.Draw.Event.CREATED, function (event) {
      demoDrawnItems.clearLayers();
      var layer = event.layer;
      demoDrawnItems.addLayer(layer);
      if (polygon2dLayer) polygon2dLayer.remove();
      polygon2dLayer = layer;
      if (layer instanceof L.Polygon) {
        selectedZoneCoords = layer.getLatLngs()[0].map(function(latlng) {
          return [latlng.lng, latlng.lat];
        });
        // Center for 3D
        let lats = layer.getLatLngs()[0].map(ll => ll.lat);
        let lngs = layer.getLatLngs()[0].map(ll => ll.lng);
        selectedZoneCenter = [lngs.reduce((a,b)=>a+b,0)/lngs.length, lats.reduce((a,b)=>a+b,0)/lats.length];
      } else {
        selectedZoneCoords = null;
        selectedZoneCenter = null;
      }
      showZoneWidgets(selectedZoneCoords);
      drawPolygonOn3D();
    });
    // Al editar zona
    demoMap.on(L.Draw.Event.EDITED, function (event) {
      var layers = event.layers;
      layers.eachLayer(function(layer) {
        var coords = null;
        if (layer instanceof L.Polygon) {
          coords = layer.getLatLngs()[0].map(function(latlng) {
            return [latlng.lng, latlng.lat];
          });
        } else if (layer instanceof L.Marker) {
          coords = [layer.getLatLng().lng, layer.getLatLng().lat];
        } else if (layer instanceof L.Rectangle) {
          coords = layer.getLatLngs()[0].map(function(latlng) {
            return [latlng.lng, latlng.lat];
          });
        }
        alert('Zona editada: ' + JSON.stringify(coords));
      });
    });
    // Al borrar zona
    demoMap.on(L.Draw.Event.DELETED, function (event) {
      selectedZoneCoords = null;
      selectedZoneCenter = null;
      polygon2dLayer = null;
      if (map3d && map3d.getLayer('zone-polygon')) { map3d.removeLayer('zone-polygon'); map3d.removeSource('zone-polygon'); }
      hideZoneWidgets();
    });
    // Pron√≥stico 7 d√≠as (simulado)
    const forecastList = document.getElementById('forecastList');
    // Historial de Riego
    new Chart(document.getElementById('histChart1').getContext('2d'), {
      type: 'bar',
      data: {
        labels: Array.from({length: 21}, (_, i) => `D√≠a ${i+1}`),
        datasets: [{
          label: 'Riego aplicado (mm)',
          data: Array.from({length: 21}, () => (Math.random() > 0.7 ? (2 + Math.random()*3).toFixed(1) : 0)),
          backgroundColor: '#1976d2'
        }]
      },
      options: { plugins: { legend: { display: false }, title: {display:true, text:'Historial de Riego (3 Semanas)'} }, scales: { y: { beginAtZero: true } } }
    });
    new Chart(document.getElementById('histChart2').getContext('2d'), {
      type: 'line',
      data: {
        labels: Array.from({length: 21}, (_, i) => `D√≠a ${i+1}`),
        datasets: [{
          label: 'Humedad del Suelo (%)',
          data: Array.from({length: 21}, () => (55 + Math.random()*15).toFixed(0)),
          borderColor: '#43a047',
          fill: false,
          tension: 0.4
        }]
      },
      options: { plugins: { legend: { display: false }, title: {display:true, text:'Humedad del Suelo (3 Semanas)'} }, scales: { y: { beginAtZero: true } } }
    });
    new Chart(document.getElementById('histChart3').getContext('2d'), {
      type: 'line',
      data: {
        labels: Array.from({length: 21}, (_, i) => `D√≠a ${i+1}`),
        datasets: [{
          label: 'Temperatura Media (¬∞C)',
          data: Array.from({length: 21}, () => (19 + Math.random()*6).toFixed(1)),
          borderColor: '#ff9800',
          fill: false,
          tension: 0.4
        }]
      },
      options: { plugins: { legend: { display: false }, title: {display:true, text:'Temperatura Media (3 Semanas)'} }, scales: { y: { beginAtZero: true } } }
    });
    // Calendario de Riego
    const tbody = document.querySelector('#riegoCalendar tbody');
    tbody.innerHTML = '';
    for (let i=0; i<7; i++) {
      const dia = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'][i];
      const hora = `${8 + Math.floor(Math.random()*6)}:00`;
      const duracion = 20 + Math.floor(Math.random()*25);
      const temp = (20 + Math.random()*8).toFixed(1);
      const hum = (50 + Math.random()*20).toFixed(0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dia}</td><td>${hora}</td><td>${duracion}</td><td>${temp}</td><td>${hum}</td>`;
      tbody.appendChild(tr);
    }
    // MAPA 3D
    function drawPolygonOn3D() {
      if (!map3d || !selectedZoneCoords) return;
      // Remove previous
      if (polygon3dLayer) { map3d.removeLayer('zone-polygon'); map3d.removeSource('zone-polygon'); polygon3dLayer = null; }
      map3d.addSource('zone-polygon', {
        'type': 'geojson',
        'data': {
          'type': 'Feature',
          'geometry': {
            'type': 'Polygon',
            'coordinates': [selectedZoneCoords]
          }
        }
      });
      map3d.addLayer({
        'id': 'zone-polygon',
        'type': 'fill',
        'source': 'zone-polygon',
        'layout': {},
        'paint': {
          'fill-color': '#3388ff',
          'fill-opacity': 0.3
        }
      });
      polygon3dLayer = true;
      // Center map
      if (selectedZoneCenter) map3d.flyTo({center: selectedZoneCenter, zoom: 14});
    }
    // BOT√ìN 3D/2D
    let is3D = false;
    let map2dDiv = document.getElementById('sisri-demo-map');
    let map3dDiv = document.getElementById('sisri-demo-map3d');
    let map3d = null;
    // Ensure both map divs always have the correct size and visibility
    function syncMapDivSizes() {
      map2dDiv.style.width = '100%';
      map2dDiv.style.height = '100%';
      if (map3dDiv) {
        map3dDiv.style.width = '100%';
        map3dDiv.style.height = '100%';
      }
    }
    window.addEventListener('resize', syncMapDivSizes);
    syncMapDivSizes();
    document.getElementById('toggle3d').addEventListener('click', function() {
      is3D = !is3D;
      syncMapDivSizes();
      if (is3D) {
        map2dDiv.style.display = 'none';
        if (!map3dDiv) {
          map3dDiv = document.createElement('div');
          map3dDiv.id = 'sisri-demo-map3d';
          map3dDiv.style.height = map2dDiv.offsetHeight ? map2dDiv.offsetHeight + 'px' : '380px';
          map3dDiv.style.width = map2dDiv.offsetWidth ? map2dDiv.offsetWidth + 'px' : '100%';
          map3dDiv.style.minHeight = '380px';
          map3dDiv.style.minWidth = '600px';
          map3dDiv.style.maxWidth = '1000px';
          map3dDiv.style.borderRadius = '12px';
          map3dDiv.style.overflow = 'hidden';
          map3dDiv.style.background = '#222';
          map3dDiv.style.zIndex = '1';
          map3dDiv.style.position = 'relative';
          map3dDiv.style.display = 'block';
          map2dDiv.parentNode.appendChild(map3dDiv);
        } else {
          map3dDiv.style.display = 'block';
          map3dDiv.style.height = map2dDiv.offsetHeight ? map2dDiv.offsetHeight + 'px' : '380px';
          map3dDiv.style.width = map2dDiv.offsetWidth ? map2dDiv.offsetWidth + 'px' : '100%';
        }
        if (!map3d) {
          setTimeout(function() {
            map3d = new maplibregl.Map({
              container: 'sisri-demo-map3d',
              style: 'https://api.maptiler.com/maps/hybrid/style.json?key=cI5UpDE37iWXyDXV4rVN',
              center: selectedZoneCenter || [ -99.1332, 19.4326 ],
              zoom: 14,
              pitch: 60,
              bearing: -17.6,
              antialias: true
            });
            map3d.on('load', drawPolygonOn3D);
          }, 100);
        } else {
          map3d.resize();
          drawPolygonOn3D();
        }
        this.textContent = 'Vista 2D';
      } else {
        if (map3dDiv) map3dDiv.style.display = 'none';
        map2dDiv.style.display = 'block';
        syncMapDivSizes();
        this.textContent = 'Vista 3D/2D';
      }
    });
  </script>

</body>
</html>
